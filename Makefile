VIRTUAL_ENV ?= /usr

PYTHON = $(VIRTUAL_ENV)/bin/python
PIP = $(VIRTUAL_ENV)/bin/pip
MYPY = $(VIRTUAL_ENV)/bin/mypy

.PHONY: clean runserver webpack_watch pip_requirements django_migrations frontend build

build: frontend specifyweb/settings/build_version.py specifyweb/settings/secret_key.py django_migrations

frontend:
	$(MAKE) -C specifyweb/frontend/js_src

pip_requirements:
	$(PIP) install --upgrade -r requirements.txt

django_migrations:
	$(PYTHON) manage.py base_specify_migration --database=migrations
	$(PYTHON) manage.py migrate --database=migrations

specifyweb/settings/build_version.py: .FORCE
	if [ -z "${BUILD_VERSION}" ]; \
	then echo "VERSION = '`git describe --tags`'" > $@; \
	else echo "VERSION = '${BUILD_VERSION}'" > $@; \
	fi

specifyweb/settings/secret_key.py:
	echo "# Make this unique, and don't share it with anybody.\n# This value was autogenerated." > $@
	printf "SECRET_KEY = '%b'\n" $$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | head -c 50) >> $@

clean:
	rm -f specifyweb/settings/build_version.py
	rm -f specifyweb/settings/secret_key.py
	$(MAKE) -C specifyweb/frontend/js_src clean

runserver:
	$(PYTHON) manage.py runserver

webpack_watch:
	$(MAKE) -C specifyweb/frontend/js_src watch

MYPY_TARGETS = \
	specifyweb/backend/permissions \
	specifyweb/backend/workbench \
	specifyweb/backend/accounts \
	specifyweb/specify/models_utils/schema.py \
	specifyweb/specify/models_utils/load_datamodel.py \
	specifyweb/specify/api/crud.py \
	specifyweb/specify/api/dispatch.py \
	specifyweb/specify/api/validators.py \
	specifyweb/specify/api/serializers.py \
	specifyweb/specify/api/api_utils.py \
	specifyweb/backend/context/user_resources.py

typecheck:
	$(MYPY) --follow-imports silent $(MYPY_TARGETS)

.FORCE:
